FROM php:7.3-fpm-alpine

WORKDIR /var/www

RUN docker-php-ext-install pdo pdo_mysql

# Storage is setup as a volume but it's not possible
# to set permissions without creating it here first.
# Apparently these permissions are maintained on the
# volume.
# https://github.com/docker/compose/issues/3270#issuecomment-363478501
RUN mkdir storage
RUN chown -R www-data:www-data storage

RUN apk add --no-cache $PHPIZE_DEPS \
    && pecl install xdebug-2.7.0 \
    && docker-php-ext-enable xdebug

RUN echo "zend_extension=$(find /usr/local/lib/php/extensions/ -name xdebug.so)" > /usr/local/etc/php/conf.d/xdebug.ini \
    && echo "xdebug.remote_enable=on" >> /usr/local/etc/php/conf.d/xdebug.ini \
    && echo "xdebug.remote_port=9001" >> /usr/local/etc/php/conf.d/xdebug.ini \
    && echo "xdebug.remote_connect_back=0" >> /usr/local/etc/php/conf.d/xdebug.ini \
    && echo "xdebug.remote_autostart=off" >> /usr/local/etc/php/conf.d/xdebug.ini \
    && echo "xdebug.idekey=PHPSTORM" >> /usr/local/etc/php/conf.d/xdebug.ini
